image: portal-common-docker.art.rambler.ru/builder

stages:
  - test
  - build

test:
  stage: test
  tags:
    - docker
  except:
    - /^gh-pages/
  script:
    - npm install
    - npm run eslint
    - npm run test

build_site:
  stage: build
  tags:
    - docker
  except:
    - /gh-pages/
    - tags
  when: manual
  script:
    - npm install
    - cd site
    - npm install
    - npm run gh-pages -- --omitGithub --versions "${CI_COMMIT_REF_NAME}"
    - cd ..

build_version:
  stage: build
  tags:
    - docker
  except:
    - /gh-pages/
  only:
    - tags
  script:
    - npm install
    - cd site
    - npm install
    - npm run gh-pages -- --omitGithub --versions "${CI_COMMIT_TAG}"
    - cd ..
    - npm run build
    - npm config set registry https://art.rambler.ru/api/npm/rambler-common/
    - curl -u${PROJECT_NPM_USER}:${PROJECT_NPM_AUTH_KEY} 'https://art.rambler.ru/api/npm/auth' > ~/.npmrc
    - cd build
    - sed -i -e 's/\"rambler\-ui\"/\"@rambler\-common\/rambler\-ui\"/' ./package.json
    - npm publish
    - npm set registry https://art.rambler.ru/api/npm/npm-cache/
    - rm ~/.npmrc

pages:
  stage: build
  tags:
    - docker
  only:
    - /gh-pages/
  script:
    - echo 'Gitlab Pages build...'
  artifacts:
    untracked: false
    paths:
      - '.'
